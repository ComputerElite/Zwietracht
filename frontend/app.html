<!DOCTYPE html>
<html>
    <head>
        {meta}
        <title>Zwietracht</title>
    </head>
    <body>
        <div class="content">
            <h1>Welcome to Zwietracht</h1>
            <i>The best chatting system on the entire planet</i>

            <h2>Who am I</h2>
            <table>
                <tr>
                    <td>nickname</td>
                    <td id="nickname">loading, please wait</td>
                </tr>
                <tr>
                    <td>id</td>
                    <td id="id">loading, please wait</td>
                </tr>
            </table>
            <h2>Create channel</h2>
            Seperate participants by comma
            <input type="text" id="participants" placeholder="ComputerElite, EnderdracheLP">
            <input type="button" value="Create" onclick="CreateChannel()">
            <h2>Channels</h2>
            <div id="channels">loading, please wait</div>
            <h2>Chat</h2>
            <div id="messages">
                Select a channel
            </div>
            <input type="text" id="message" onkeydown="if(event.code == 'Enter') SendMessage()" placeholder="Type your message here">
            <input type="button" value="Send" onclick="SendMessage()">
            <input type="button" value="Upload image" onclick="UploadImage()">
            <input type="button" value="Call" onclick="Call()">
            <div class="call" id="call">
                <input type="button" value="End Call" onclick="EndCall()">
                <input type="button" value="Mute yourself" onclick="Mute()">
                <div class="inline">You are currently <div id="mutedstate" class="inline"></div></div>
            </div>
            <div id="images">

            </div>
            <script src="script.js"></script>
            <script>
                var me = {}
                var currentChannel = 0
                RequestMe()
                function RequestMe() {
                    jfetch("/api/v1/me").then(res => {
                        me = res
                        UpdateUI()
                    })
                }

                var calling = false
                var muted = false

                function Mute() {
                    muted = !muted
                    document.getElementById("mutedstate").innerHTML = muted ? "Muted" : "Unmuted"
                }

                function EndCall() {
                    calling = false
                }

                
                function Call() {
                    if(calling) return;
                    document.getElementById("mutedstate").innerHTML = muted ? "Muted" : "Unmuted"
                    calling = true
                    document.getElementById("call").style.display = "block"
                    const interval = 256
                    navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
                        var loopId = setInterval(() => {
                            if(!calling)
                            {
                                document.getElementById("call").style.display = "none"
                                clearInterval(loopId)
                            }
                            const mediaRecorder = new MediaRecorder(stream);
                            let audioChunks = [];

                            mediaRecorder.ondataavailable = function(e) {
                                audioChunks.push(e.data);
                            }
                            mediaRecorder.start();
                            mediaRecorder.onstop = function(e) {
                                var reader = new window.FileReader();
                                reader.readAsDataURL(new Blob(audioChunks, { 'type': 'audio/ogg; codecs=opus' })); 
                                reader.onloadend = function() {
                                    base64 = reader.result;
                                    if(!muted) {
                                        tfetch("/api/v1/call", "POST", localStorage.token + "|call|" + currentChannel + "|" + base64).then(res => {
                                            var chunks = res.split("|")
                                            chunks.forEach(x => {
                                                if(x != "") {
                                                    var audio = document.createElement("audio")
                                                    audio.src = x
                                                    audio.play()
                                                }
                                            })
                                        })
                                    }
                                }
                            }
                            setTimeout(() => {
                                mediaRecorder.stop();
                            }, interval);
                        }, interval - 20);
                        
                    }).catch(err => {
                        alert("fuck you")
                        console.log(err)
                    })
                    
                }
                
                var ws = new WebSocket(location.protocol.replace("http", "ws") + "//" + window.location.host)

                ws.onopen = () => {
                    console.log("connection opened, registering on server")
                    //ws.send(localStorage.token + "|register")
                }

                var attachments = []

                function UploadImage() {
                    var input = document.createElement("input")
                    input.setAttribute("type", "file")
                    input.setAttribute("accept", "image/*")
                    input.click()

                    input.onchange = function (e) {
                        if (!this.files[0]) {
                            return;
                        }

                        var reader = new FileReader();
                        reader.onload = function(e) {
                            attachments.push({
                                base64: e.target.result
                            })
                            UpdateMessageUI()
                        }
                        reader.readAsDataURL(this.files[0])
                    }
                }

                document.onpaste = function(event) {
                    var items = (event.clipboardData || event.originalEvent.clipboardData).items;
                    for (index in items) {
                        var item = items[index];
                            if (item.kind === 'file') {
                            var blob = item.getAsFile();
                            var reader = new FileReader();
                            reader.onload = function(event){
                                attachments.push({
                                    base64: event.target.result,
                                })
                                UpdateMessageUI()
                            }
                            reader.readAsDataURL(blob);
                        }
                    }
                }

                function UpdateMessageUI() {
                    var html = ""
                    for (var i = 0; i < attachments.length; i++) {
                        html += "<img src='" + attachments[i].base64 + "'>"
                    }
                    document.getElementById("images").innerHTML = html
                }

                var lastMessage = 0

                function PlayPing() {
                    var audio = document.createElement("audio")
                    audio.src = "/ping.mp3"
                    audio.play()
                }

                var first = false;

                ws.onmessage = (e) => {
                    if(e.data.startsWith("{") || e.data.startsWith("[")) {
                        
                        var res = JSON.parse(e.data)
                        const messages = document.getElementById("messages")
                        var scroll = messages.scrollHeight - messages.clientHeight <= messages.scrollTop + 1;
                        //messages.innerHTML = ""
                        res.reverse().forEach(x => {
                            if(lastMessage < parseInt(x.id))  {
                                if(!first) PlayPing()
                                lastMessage = parseInt(x.id)
                                var m = ""
                                x.attachments.forEach(a => {
                                    m = `<img class="attachment" src="${a.url}">` + m
                                })
                                m = `<div><div class='username'>${x.author.nickname}</div>: <div class="inline date">${GetTimeString(x.sendTime)}</div><br>${SafeFormat(x.content)}</div>` + m
                                var message = document.createElement("div")
                                message.className = "message"
                                message.innerHTML = m
                                messages.append(message)
                            }
                        })
                        
                        first = false;
                        if(scroll) messages.scrollTop = messages.scrollHeight
                    } else {
                        var chunks = e.data.split("|")
                        chunks.forEach(x => {
                            if(x != "") {
                                var audio = document.createElement("audio")
                                audio.src = x
                                audio.play()
                            }
                        })
                    }
                    
                }

                function CreateChannel() {
                    var participants = []
                    participants.push({
                        nickname: me.nickname
                    })
                    document.getElementById("participants").value.split(',').forEach(x => {
                        participants.push({
                            nickname: x.trim()
                        })
                    })
                    tfetch("/api/v1/createchannel", "POST", JSON.stringify({
                        participants: participants
                    })).then(res => {
                        RequestMe()
                    })
                }

                setInterval(() => {
                    UpdateChannel()
                }, 1000)

                setInterval(() => {
                    RequestMe()
                }, 10000)

                function UpdateChannel() {
                    if(currentChannel == 0) {
                        document.getElementById("messages").innerHTML = "Select a channel"
                        return
                    }
                    ws.send(`${localStorage.token}|messages|${currentChannel}`)
                }

                function SendMessage() {
                    tfetch("/api/v1/messages/" + currentChannel, "POST", JSON.stringify({
                        author: {
                            nickname: me.nickname,
                            id: me.id
                        },
                        attachments: attachments,
                        content: document.getElementById("message").value
                    })).then(res => {
                        AfterSendCleanup()
                        first = true
                        UpdateChannel()
                    })
                }

                function AfterSendCleanup() {
                    document.getElementById("message").value = ""
                    attachments = []
                    UpdateMessageUI()
                }

                function OpenChannel(id) {
                    currentChannel = id
                    first = true
                    messages.innerHTML = ""
                    lastMessage = 0;
                    UpdateChannel()
                }

                function UpdateUI() {
                    document.getElementById("nickname").innerHTML = SafeFormat(me.nickname)
                    document.getElementById("id").innerHTML = SafeFormat(me.id.toString())
                    const channels = document.getElementById("channels")
                    channels.innerHTML = "";
                    me.channels.forEach(x => {
                        var participants = ""
                        x.participants.forEach(p => {
                            if(p.id != me.id || x.participants.length < 2) participants += p.nickname + ", ";
                        })
                        if(participants.length > 0) participants = participants.substring(0, participants.length - 2)
                        channels.innerHTML += `<div class="channel">
                                <a onclick="OpenChannel('${x.id}')">${participants}</a>
                            </div>`
                    })
                }
            </script>
        </div>
    </body>
</html>